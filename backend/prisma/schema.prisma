// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String
  role        String       @default("student")
  credentials Credential[]
  challenges  Challenge[]
  teacher     Teacher?
  student     Student?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([role])
}

model Credential {
  id        String   @id
  publicKey Bytes
  counter   BigInt
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Challenge {
  id        String   @id @default(cuid())
  challenge String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  expiresAt DateTime @default(now())
}

model Teacher {
  id        Int       @id @default(autoincrement())
  user      User      @relation(fields: [userId], references: [id])
  userId    String    @unique
  problems  Problem[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Student {
  id          Int          @id @default(autoincrement())
  user        User         @relation(fields: [userId], references: [id])
  userId      String       @unique
  submissions Submission[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Problem {
  id                 Int          @id @default(autoincrement())
  title              String
  body               String
  testCases          TestCase[]
  supportedLanguages Language[]
  submissions        Submission[]
  teachers           Teacher[]
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
}

model TestCase {
  id        Int          @id @default(autoincrement())
  input     String
  output    String
  problem   Problem      @relation(fields: [problemId], references: [id])
  problemId Int
  results   TestResult[]
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model TestResult {
  id           Int         @id @default(autoincrement())
  status       TestStatus  @relation(fields: [statusId], references: [status])
  statusId     String
  message      String
  testCase     TestCase    @relation(fields: [testCaseId], references: [id])
  testCaseId   Int
  submission   Submission? @relation(fields: [submissionId], references: [id])
  submissionId Int?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

model TestStatus {
  status  String       @id
  results TestResult[]
}

model SupportedLanguage {
  name        String
  version     String
  languages   Language[]
  submissions Submission[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@id([name, version])
}

model Language {
  id              Int               @id @default(autoincrement())
  language        SupportedLanguage @relation(fields: [languageName, languageVersion], references: [name, version])
  languageName    String
  languageVersion String
  problem         Problem?          @relation(fields: [problemId], references: [id])
  problemId       Int?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

model Submission {
  id              Int               @id @default(autoincrement())
  code            String
  language        SupportedLanguage @relation(fields: [languageName, languageVersion], references: [name, version])
  languageName    String
  languageVersion String
  result          SubmissionResult  @relation(fields: [resultId], references: [id])
  resultId        Int               @unique
  testResults     TestResult[]
  student         Student           @relation(fields: [studentId], references: [id])
  studentId       Int
  problem         Problem           @relation(fields: [problemId], references: [id])
  problemId       Int
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

model SubmissionResult {
  id         Int              @id @default(autoincrement())
  submission Submission?
  status     SubmissionStatus @relation(fields: [statusId], references: [status])
  statusId   String
  message    String
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

model SubmissionStatus {
  status  String             @id
  results SubmissionResult[]
}
